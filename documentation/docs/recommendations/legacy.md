---
sidebar_position: 4
---

# Внедрение тестирования в существующую разработку (Legacy)

## Что такое Legacy-код

Legacy-код — это код, который был разработан в прошлом, все еще используется, но его сложно поддерживать и изменять. Причины продолжения работы с такими системами обычно связаны с затратами и временем, необходимыми для создания новой аналогичной системы, хотя иногда также существует недостаток осознания будущих последствий текущих усилий по написанию кода.

Факт в том, что со временем код начинает "портиться". Это может происходить из-за:
* Изменений требований
* Плохо продуманного дизайна
* Применения антипаттернов
* Отсутствия соответствующих тестов

В конечном итоге код становится трудным для поддержки и сложным для изменения.

## Почему тесты важны для Legacy-кода

Существует много подходов для предотвращения «гниения» кода, но одним из самых эффективных может быть написание тестируемого кода с последующим созданием достаточного количества модульных тестов для этого кода. Модульные тесты:

* Выполняют роль агентов, которые непрерывно проверяют систему
* Выявляют проблемные ошибки
* Показывают влияние изменений на всю систему
* Дают разработчику уверенность в отсутствии регрессий

## Сложности при тестировании Legacy-кода

### Основные проблемы

1. **Большой объем кода** — для набора тестов может потребоваться больше кода, чем для самого тестируемого кода
2. **Сложные зависимости** — чем сложнее решение, тем больше зависимостей между классами
3. **Необходимость в моках и стабах** — требуются дополнительные знания и опыт
4. **Высокая стоимость внедрения** — необходимость в рефакторинге и создании тестовых данных

### Стоимость внедрения

Стоимость в основном складывается из двух составляющих:

1. **Стоимость внедрения тестового фреймворка:**
   * Обучение команды
   * Настройка CI
   * Выработка регламентов

2. **Стоимость подготовки кода:**
   * Рефакторинг для тестируемости
   * Создание тестовых данных
   * Анализ взаимосвязей между объектами

## Выгода от внедрения модульных тестов

* **Фиксация требований** — тесты документируют ожидаемое поведение системы
* **Защита от регресса** — предотвращение появления старых ошибок
* **Документация** — тесты как живая документация системы
* **Отладка** — быстрое выявление проблем
* **Рефакторинг** — безопасное изменение кода

## Рекомендации по внедрению

### Организационные аспекты

1. **Получите поддержку команды:**
   * Заручитесь поддержкой технического лида
   * Продайте идею тестирования команде
   * Назначьте ответственных за внедрение

2. **Разработайте план:**
   * Определите приоритетные области для тестирования
   * Установите метрики успеха
   * Создайте регламенты работы с тестами

### Технические аспекты

1. **Начните с малого:**
   * Тестируйте только дорабатываемый код
   * Начните с одного-двух тест-кейсов на задачу
   * Выбирайте простые компоненты без сложных зависимостей

2. **Постепенно расширяйте покрытие:**
   * Добавляйте тесты при доработке функционала
   * Увеличивайте количество тест-кейсов
   * Внедряйте более сложные сценарии тестирования

## План работ

1. **Подготовительный этап:**
   * Обучение работе с тестовым движком
   * Изучение основных рекомендаций
   * Создание тестовой базы

2. **Начальный этап:**
   * Написание простых тестов
   * Выбор объектов с минимальными зависимостями
   * Фокус на очевидных тест-кейсах

3. **Развитие:**
   * Расширение покрытия тестами
   * Внедрение более сложных сценариев
   * Оптимизация тестов

## Чего избегать

* Не начинайте тестировать классы с множеством зависимостей
* Не тестируйте внутреннюю реализацию
* Не пишите много ассертов в одном тесте
* Не бойтесь дублирования в тестах ради их выразительности
* Не пытайтесь протестировать весь легаси сразу

## Использованные материалы

* [Еще раз про тестирование](https://otis22.github.io/tdd,/unit,/integration/2021/01/28/about-testing.html)
* [Еще раз про тестирование 2(Как тестировать legacy)](https://otis22.github.io/tdd,/unit,/integration/2021/02/01/about-testing-2.html)
* https://bureau.ru/soviet/20170511/
* https://dzen.ru/a/YiSVvZq2dn409d1y